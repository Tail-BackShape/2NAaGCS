# 2NAa Ground Control Station (GCS) 仕様書

## 概要

2NAa GCS は、無人航空機（UAV）の地上制御局システムです。リアルタイム制御、自動操縦機能、ArUcoマーカーを使用した自動離着陸機能を統合したPython/PySide6ベースのGUIアプリケーションです。

## システム構成

### ハードウェア要件
- Windows環境（pwsh対応）
- シリアル通信インターフェース（COM22デフォルト、115200bps）
- Webカメラ（映像ストリーミング用）
- ArUcoマーカー（自動離着陸用）

### ソフトウェア要件
- Python 3.8以上
- PySide6（GUI）
- OpenCV（画像処理）
- NumPy（数値計算）
- シリアル通信ライブラリ

## 機能概要

### 1. 基本制御機能
- **リアルタイムテレメトリ表示**：ロール、ピッチ、ヨー角度、高度の可視化
- **スティック入力表示**：ラダー、エレベーター、エルロン、スロットル値の表示
- **PID制御パラメータ調整**：ロール、ピッチ、ヨーのPIDゲイン設定

### 2. 自動操縦機能
- **水平旋回**：指定角度での水平旋回制御
- **上昇旋回**：高度変更を伴う複合旋回制御
- **8の字飛行**：右旋回→左旋回の連続制御

### 3. 自動離着陸機能
- **ArUcoマーカー認識**：3つのマーカーによる位置推定
- **フェーズ制御**：離陸→投下→定常→着陸の段階的制御
- **個別キャリブレーション**：マーカー毎の位置・距離補正

## ユーザーインターフェース

### タブ構成

#### GCSタブ
基本的な制御・監視機能を提供

**左パネル**
- 接続設定：COMポート選択、接続/切断
- 計器表示：ADI（姿勢表示器）、高度計
- スティック表示：操縦入力値の可視化
- 映像制御：Webカメラ映像のオン/オフ

**右パネル**
- 映像表示：リアルタイム映像ストリーム
- PIDパラメータ：制御ゲインの調整
- 自動操縦パラメータ：ミッション設定値
- 2D姿勢表示：ピッチ・ヨー角の可視化

#### 自動離着陸タブ
ArUcoマーカーベースの自動着陸機能

**左パネル**
- 自動離着陸制御：有効化/無効化、フェーズ表示
- 操縦量表示：自動制御時の操舵量
- 制御パラメータ：自動離着陸用の設定値

**中央パネル**
- 位置表示：XY平面、ZY平面での機体・マーカー位置
- 姿勢表示：ピッチ・ヨー角の2D表示

**右パネル**
- ArUcoマーカー個別キャリブレーション：各マーカーの位置・距離補正

#### キャリブレーションタブ
距離推定キャリブレーションデータの可視化・管理

- グラフ表示：マーカーサイズ vs 距離の関係
- データ管理：キャリブレーションデータの保存・読み込み
- マーカー選択：個別または全マーカーの表示切り替え

## 自動操縦システム詳細

### 制御アーキテクチャ

#### 1. 状態管理
```
自動操縦状態変数：
- autopilot_active: 自動操縦の有効/無効
- active_mission_mode: 現在のミッション種別
- mission_total_rotation: ミッション開始からの累積回転角
- mission_start_yaw: ミッション開始時のヨー角
- mission_start_altitude: ミッション開始時の高度
```

#### 2. ミッション種別
- **0: Manual** - 手動操縦
- **1: Horizontal Turn** - 水平旋回
- **2: Ascending Turn** - 上昇旋回  
- **3: Figure-8** - 8の字飛行

#### 3. トリガー条件
AUXスイッチによる自動切り替え：
```
AUX1 & AUX2 & AUX3 = 1 → 水平旋回開始
AUX1 & AUX2 & AUX4 = 1 → 上昇旋回開始
AUX1 & AUX3 & AUX4 = 1 → 8の字飛行開始
```

### 水平旋回制御（Horizontal Turn）

#### アルゴリズム
1. **初期化**：現在のヨー角・高度を基準値として記録
2. **バンク角制御**：指定バンク角（デフォルト20度）で旋回
3. **ヨー角追跡**：累積回転角が目標値（デフォルト760度）に到達まで継続
4. **完了判定**：目標回転角到達で水平姿勢に復帰

#### 制御パラメータ
- `bank_angle`: 旋回時のバンク角（度）
- `horizontal_turn_target`: 目標累積回転角（度）
- `autopilot_throttle_base`: 基準スロットル値

#### 制御ロジック
```
IF mission_total_rotation >= horizontal_target THEN
    バンク角 = 0（水平復帰）
    ミッション完了
ELSE
    バンク角 = -bank_angle（左旋回）
    高度制御でスロットル調整
```

### 上昇旋回制御（Ascending Turn）

#### 4フェーズ制御
1. **フェーズ0**: 2.5m高度保持で左旋回2回（-720度）
2. **フェーズ1**: 旋回しながら5mまで上昇
3. **フェーズ2**: 5m高度保持で左旋回2回（-720度）
4. **完了**: 水平姿勢復帰

#### アルゴリズム詳細
```
フェーズ0（2.5m水平旋回）：
IF 現在高度 > 2.5m + 閾値 THEN スロットル減少
IF 現在高度 < 2.5m - 閾値 THEN スロットル増加
IF 累積回転 >= -720° THEN フェーズ1へ

フェーズ1（上昇中旋回）：
目標高度 = 5.0m
スロットル = 高度誤差に比例制御
IF 現在高度 >= 4.8m THEN フェーズ2へ

フェーズ2（5m水平旋回）：
IF 現在高度 > 5.0m + 閾値 THEN スロットル減少  
IF 現在高度 < 5.0m - 閾値 THEN スロットル増加
IF このフェーズでの累積回転 >= -720° THEN 完了
```

#### 制御パラメータ
- `altitude_low`: フェーズ0の目標高度（2.5m）
- `altitude_high`: フェーズ2の目標高度（5.0m）
- `ascending_turn_target1`: フェーズ0完了判定角（-760度）
- `altitude_throttle_gain`: 高度制御ゲイン

### 8の字飛行制御（Figure-8）

#### 2フェーズ制御
1. **フェーズ0**: 右旋回（目標：300度）
2. **フェーズ1**: 左旋回（目標：-320度）

#### 制御ロジック
```
フェーズ0（右旋回）：
バンク角 = +bank_angle
IF 累積回転 >= figure8_right_target THEN フェーズ1へ

フェーズ1（左旋回）：
バンク角 = -bank_angle  
IF このフェーズでの累積回転 <= figure8_left_target THEN 完了
```

#### 制御パラメータ
- `figure8_right_target`: 右旋回目標角（300度）
- `figure8_left_target`: 左旋回目標角（-320度）

### ヨー角追跡システム

#### 境界クロッシング処理
0-359度システムでの角度変化を正確に追跡：
```
yaw_change = current_yaw - previous_yaw

IF yaw_change > 180 THEN
    yaw_change -= 360  // 350°→10° を +20°として処理
ELSE IF yaw_change < -180 THEN  
    yaw_change += 360  // 10°→350° を -20°として処理
    
mission_total_rotation += yaw_change
```

#### デバッグ出力
- 1秒間隔：基本ヨー情報（現在角、変化量、累積回転）
- 5秒間隔：ミッション固有情報（フェーズ、進捗、目標値）

### 高度制御システム

#### PID制御ベース
```
高度誤差 = 目標高度 - 現在高度
スロットル調整 = altitude_throttle_gain × 高度誤差
最終スロットル = base_throttle + スロットル調整

制限：
throttle_min ≤ 最終スロットル ≤ throttle_max
```

## 自動離着陸システム詳細

### ArUcoマーカーベース位置推定

#### マーカー配置
- **マーカー1**: 滑走路左側（-3m, 6m）
- **マーカー2**: 滑走路中央（0m, 0m）  
- **マーカー3**: 滑走路右側（3m, 6m）

#### 距離推定アルゴリズム
各マーカーから独立して距離を推定：
```
推定距離 = キャリブレーション距離 × キャリブレーションサイズ / 現在サイズ

複数キャリブレーション点の場合：
線形補間により現在サイズに対応する距離を算出
```

### フェーズ制御システム

#### フェーズ遷移
```
0: Manual → 手動操縦
1: Takeoff → 離陸：距離 > takeoff_distance_threshold
2: Drop → 投下：距離 ≤ drop_distance_threshold  
3: Steady → 定常：投下完了後の安定飛行
4: Landing → 着陸：距離 ≤ landing_distance_threshold
```

#### 制御ロジック詳細

**離陸フェーズ（Takeoff）**
```
スロットル = takeoff_throttle（最大出力）
高度制御：なし（上昇優先）
IF 推定距離 > takeoff_distance_threshold THEN
    投下フェーズへ遷移
```

**投下フェーズ（Drop）**
```  
スロットル = pre_drop_throttle
高度制御：steady_altitude目標
IF 推定距離 ≤ drop_distance_threshold THEN
    投下実行 & 定常フェーズへ遷移
```

**定常フェーズ（Steady）**
```
スロットル = post_drop_throttle  
高度制御：steady_altitude目標
ラダー制御：マーカー中心への誘導
IF 推定距離 ≤ landing_distance_threshold THEN
    着陸フェーズへ遷移
```

**着陸フェーズ（Landing）**
```
スロットル = 最小値（throttle_min）
制御：着陸のための出力減少
```

### キャリブレーションシステム

#### 個別マーカーキャリブレーション
各マーカーに対して独立設定：
- **位置オフセット**: X、Y座標の補正値
- **角度オフセット**: 向き補正（将来拡張）
- **距離キャリブレーション**: サイズ-距離関係の学習

#### データ保存形式
```
テキストファイル: marker_calibrations.txt
marker_1_offset_x=0.0
marker_1_offset_y=0.0  
marker_1_offset_angle=0.0

JSONファイル: calibration_export_YYYYMMDD_HHMMSS.json  
{
  "export_time": "ISO datetime",
  "markers": {
    "1": [{"distance": 5.0, "size": 120.5, "x": 10, "y": 20}]
  }
}
```

## 通信プロトコル

### シリアル通信仕様
- **ボーレート**: 115200bps
- **データ形式**: ASCII文字列（改行区切り）
- **受信周期**: 50ms（20Hz）

### データフォーマット
```
受信データ（24パラメータ）：
[0-3]: ail, elev, rudd, thro（RC入力）
[4-7]: aux1, aux2, aux3, aux4（AUXスイッチ）  
[8-11]: roll, pitch, yaw, alt（姿勢・高度）
[12-23]: ArUcoマーカー情報×3
  - size, id, x, y（各マーカー4パラメータ）

送信データ（制御コマンド）：
"ail,elev,rudd,thro" 形式でRC値を送信
```

### エラーハンドリング
- **通信エラー**: 前回値を保持、エラーメッセージ表示
- **データ異常**: 0.0値や大きな変化を検出時は前回値使用
- **マーカー未検出**: サイズ=0で判定、推定距離を無効化

## デバッグ・ログ機能

### ヨー角デバッグ
```
基本情報（1秒間隔）：
"YAW DEBUG: current=X°, change=Y°, total_rotation=Z°, start=W°"

ミッション情報（5秒間隔）：
水平旋回: "高度=X m, 総回転=Y°, 目標=Z°"
上昇旋回: "フェーズ=X, 高度=Y m, 回転=Z°"  
8の字: "フェーズ=X, 総回転=Y°, 右目標=A°, 左目標=B°"
```

### 高度変化ログ
```
"高度変化: Xmm -> Ymm (差: Zmm)" 
1m以上の変化時に出力
```

## 設定ファイル

### PID設定（coef.txt）
```
roll_p=0.1
roll_i=0.01  
roll_d=0.05
（pitch, yaw同様）
```

### 自動操縦設定（autoGoCoef.txt）
```
bank_angle=20.0
horizontal_turn_target=760.0
ascending_turn_target1=-760.0
（その他パラメータ）
```

### 自動離着陸設定（autoGo.txt）
```
takeoff_throttle=1000.0
steady_altitude=1.5
altitude_gain=50.0
（その他パラメータ）
```

## 運用上の注意点

### 安全機能
- **手動復帰**: AUXスイッチで即座に手動操縦に復帰可能
- **制限値**: スロットル、制御量の上下限設定
- **フェーズ表示**: 現在の制御状態を常時表示

### キャリブレーション手順
1. **基本姿勢**: 機体を既知距離に配置
2. **マーカー検出**: 3つのマーカーが認識されることを確認
3. **距離記録**: 各マーカーで「距離キャリブレーション記録」実行
4. **データ保存**: 自動保存されるキャリブレーションデータを確認

### トラブルシューティング
- **通信不良**: COMポート設定、ケーブル接続確認
- **マーカー未検出**: 照明条件、マーカー角度調整
- **制御異常**: PIDパラメータ、制御制限値の確認
- **高度異常**: センサーキャリブレーション、フィルタ設定確認

## 今後の拡張可能性

### 機能拡張
- **複数機同時制御**: 複数UAVの協調制御
- **経路計画**: GPS waypoint ナビゲーション
- **障害物回避**: センサーフュージョンによる自律回避
- **気象対応**: 風況に応じた制御補正

### アルゴリズム改良
- **適応制御**: 機体特性の自動学習
- **最適制御**: LQR、MPCなどの高度な制御手法
- **機械学習**: 飛行パターンの学習・最適化
- **ロバスト制御**: 外乱・不確定性への対応強化

---

*最終更新: 2025年9月22日*
